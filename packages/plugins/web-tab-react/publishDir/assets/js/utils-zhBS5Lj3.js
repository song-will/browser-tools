var e=class{async get(e){throw Error(`get method must be implemented`)}async set(e,t){throw Error(`set method must be implemented`)}async remove(e){throw Error(`remove method must be implemented`)}async clear(){throw Error(`clear method must be implemented`)}},t=class extends e{async get(e){return new Promise((t,n)=>{if(typeof chrome<`u`&&chrome.storage)chrome.storage.local.get([e],r=>{chrome.runtime.lastError?n(chrome.runtime.lastError):t(r[e]||null)});else try{let n=localStorage.getItem(e);t(n?JSON.parse(n):null)}catch(e){n(e)}})}async set(e,t){return new Promise((n,r)=>{if(typeof chrome<`u`&&chrome.storage)chrome.storage.local.set({[e]:t},()=>{chrome.runtime.lastError?r(chrome.runtime.lastError):n()});else try{localStorage.setItem(e,JSON.stringify(t)),n()}catch(e){r(e)}})}async remove(e){return new Promise((t,n)=>{if(typeof chrome<`u`&&chrome.storage)chrome.storage.local.remove([e],()=>{chrome.runtime.lastError?n(chrome.runtime.lastError):t()});else try{localStorage.removeItem(e),t()}catch(e){n(e)}})}async clear(){return new Promise((e,t)=>{if(typeof chrome<`u`&&chrome.storage)chrome.storage.local.clear(()=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e()});else try{localStorage.clear(),e()}catch(e){t(e)}})}},n=class extends e{constructor(e,t=null){super(),this.token=e,this.gistId=t,this.baseUrl=`https://api.github.com/gists`}async get(e){if(!this.gistId)return null;try{let t=await fetch(`${this.baseUrl}/${this.gistId}`,{headers:{Authorization:`token ${this.token}`,Accept:`application/vnd.github.v3+json`}});if(!t.ok)throw Error(`Failed to fetch gist: ${t.statusText}`);let n=await t.json(),r=n.files[e]||n.files[`data.json`];return r?JSON.parse(r.content):null}catch(e){return console.error(`[Storage] GitHub Gist get error:`,e),null}}async set(e,t){if(!this.token)return null;try{let n=JSON.stringify(t,null,2),r={[e]:{content:n}};if(this.gistId){let e=await fetch(`${this.baseUrl}/${this.gistId}`,{method:`PATCH`,headers:{Authorization:`token ${this.token}`,Accept:`application/vnd.github.v3+json`,"Content-Type":`application/json`},body:JSON.stringify({files:r})});if(!e.ok)throw Error(`Failed to update gist: ${e.statusText}`);this.gistId=(await e.json()).id}else{let e=await fetch(this.baseUrl,{method:`POST`,headers:{Authorization:`token ${this.token}`,Accept:`application/vnd.github.v3+json`,"Content-Type":`application/json`},body:JSON.stringify({description:`WebTab shortcuts storage`,public:!1,files:r})});if(!e.ok)throw Error(`Failed to create gist: ${e.statusText}`);this.gistId=(await e.json()).id}return this.gistId}catch(e){return console.error(`[Storage] GitHub Gist set error:`,e),null}}async remove(e){if(!(!this.gistId||!this.token))try{let t=await fetch(`${this.baseUrl}/${this.gistId}`,{method:`PATCH`,headers:{Authorization:`token ${this.token}`,Accept:`application/vnd.github.v3+json`,"Content-Type":`application/json`},body:JSON.stringify({files:{[e]:null}})});if(!t.ok)throw Error(`Failed to remove from gist: ${t.statusText}`)}catch(e){console.error(`[Storage] GitHub Gist remove error:`,e)}}async clear(){if(!(!this.gistId||!this.token))try{let e=await fetch(`${this.baseUrl}/${this.gistId}`,{method:`PATCH`,headers:{Authorization:`token ${this.token}`,Accept:`application/vnd.github.v3+json`,"Content-Type":`application/json`},body:JSON.stringify({files:{}})});if(!e.ok)throw Error(`Failed to clear gist: ${e.statusText}`)}catch(e){console.error(`[Storage] GitHub Gist clear error:`,e)}}};function r(e,t){let n;return function(...r){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...r)},t)}}var i=class extends e{constructor(){super(),this.chromeStorage=new t,this.githubGist=null,this.syncQueue=new Map,this.syncDebounced=r(()=>this.flushSyncQueue(),2e3)}setGithubGist(e,t=null){e?this.githubGist=new n(e,t):this.githubGist=null}async flushSyncQueue(){if(!this.githubGist||this.syncQueue.size===0)return;let e=Array.from(this.syncQueue.entries());this.syncQueue.clear(),console.log(`[Storage] 开始同步到 GitHub Gist，队列大小:`,e.length);for(let[,{operation:t,key:n,value:r}]of e)try{t===`set`?(console.log(`[Storage] 同步 ${n} 到 GitHub Gist`),await this.githubGist.set(n,r),console.log(`[Storage] ${n} 同步成功`)):t===`remove`&&(console.log(`[Storage] 从 GitHub Gist 删除 ${n}`),await this.githubGist.remove(n),console.log(`[Storage] ${n} 删除成功`))}catch(e){console.error(`[Storage] Sync ${t} to GitHub Gist failed:`,e)}}async get(e){return await this.chromeStorage.get(e)}async set(e,t){await this.chromeStorage.set(e,t),this.githubGist&&(this.syncQueue.set(`set_${e}`,{operation:`set`,key:e,value:t}),this.syncDebounced())}async remove(e){await this.chromeStorage.remove(e),this.githubGist&&(this.syncQueue.set(`remove_${e}`,{operation:`remove`,key:e}),this.syncDebounced())}async clear(){await this.chromeStorage.clear(),this.githubGist&&(this.syncQueue.clear(),await this.githubGist.clear())}};const a=new class{constructor(){this.strategy=new i,this.configKey=`storage_config`}async init(){let e=await this.getStorageConfig();e&&e.enableGithub&&e.token?this.strategy.setGithubGist(e.token,e.gistId||null):this.strategy.setGithubGist(null)}async getStorageConfig(){return await new t().get(this.configKey)}async setStorageConfig(e){await new t().set(this.configKey,e),await this.init()}async get(e){return await this.strategy.get(e)}async set(e,t){return await this.strategy.set(e,t)}async remove(e){return await this.strategy.remove(e)}async clear(){return await this.strategy.clear()}async syncToGithub(){this.strategy.githubGist&&await this.strategy.flushSyncQueue()}};export{a as t};