import{It as e}from"./vendor-B-uj9Psy.js";import{t}from"./vendor-react-BJtxAQnE.js";import{a as n,b as r,c as i,d as a,l as o,n as s,o as c,p as l,r as u,v as d}from"./vendor-antd-DeIwGye1.js";import{t as f}from"./vendor-icons-62_ltRSW.js";import{t as p}from"./utils-zhBS5Lj3.js";var m=e(),h=t(),{Option:g}=d;function _({isOpen:e,onClose:t}){let[_]=o.useForm(),[v,y]=(0,m.useState)(!1),[b,x]=(0,m.useState)(!1),[S,C]=(0,m.useState)(!1),w=o.useWatch(`githubToken`,_);(0,m.useEffect)(()=>{e&&T()},[e]);let T=async()=>{try{let e=await p.getStorageConfig(),t=await p.get(`background_settings`),n=e?.enableGithub||!1;_.setFieldsValue({enableGithub:n,githubToken:e?.token||``,githubGistId:e?.gistId||``,backgroundType:t?.type||`image`,backgroundImage:t?.image||``,backgroundVideo:t?.video||``}),x(n)}catch(e){console.error(`[Settings] Load error:`,e)}},E=async e=>{y(!0);try{if(e.enableGithub){if(!e.githubToken?.trim()){c.error(`请输入 GitHub Token`),y(!1);return}let t={enableGithub:!0,token:e.githubToken.trim(),gistId:e.githubGistId?.trim()||null};await p.setStorageConfig(t),c.success(`存储设置已保存`)}else await p.setStorageConfig({enableGithub:!1}),c.success(`存储设置已保存`)}catch(e){console.error(`[Settings] Save storage error:`,e),c.error(`保存失败: `+e.message)}finally{y(!1)}},D=async e=>{y(!0);try{let t={type:e.backgroundType,image:e.backgroundImage,video:e.backgroundVideo};await p.set(`background_settings`,t),window.dispatchEvent(new CustomEvent(`backgroundChanged`,{detail:t})),c.success(`背景设置已保存`)}catch(e){console.error(`[Settings] Save background error:`,e),c.error(`保存失败: `+e.message)}finally{y(!1)}};return(0,h.jsx)(h.Fragment,{children:(0,h.jsx)(n,{title:(0,h.jsxs)(a,{children:[(0,h.jsx)(f,{}),(0,h.jsx)(`span`,{children:`设置`})]}),open:e,onCancel:t,footer:null,width:600,styles:{body:{maxHeight:`70vh`,overflowY:`auto`}},children:(0,h.jsxs)(o,{form:_,layout:`vertical`,onFinish:async e=>{await E(e),await D(e)},children:[(0,h.jsxs)(`div`,{style:{marginBottom:24},children:[(0,h.jsx)(`h3`,{style:{marginBottom:16,fontSize:16,fontWeight:500},children:`存储设置`}),(0,h.jsxs)(`div`,{style:{padding:12,marginBottom:16,borderRadius:8,backgroundColor:`rgba(0, 0, 0, 0.02)`},children:[(0,h.jsxs)(a,{children:[(0,h.jsx)(`span`,{style:{fontWeight:500},children:`Chrome Storage`}),(0,h.jsx)(s,{color:`success`,children:`默认启用`})]}),(0,h.jsx)(`div`,{style:{fontSize:12,color:`rgba(0, 0, 0, 0.45)`,marginTop:4},children:`数据将立即保存到本地 Chrome Storage，快速可靠`})]}),(0,h.jsxs)(o.Item,{name:`enableGithub`,valuePropName:`checked`,children:[(0,h.jsxs)(a,{children:[(0,h.jsx)(u,{onChange:e=>{x(e),_.setFieldValue(`enableGithub`,e)}}),(0,h.jsx)(`span`,{children:`GitHub Gist 同步（可选）`})]}),(0,h.jsx)(`div`,{style:{fontSize:12,color:`rgba(0, 0, 0, 0.45)`,marginTop:4,marginLeft:28},children:`启用后，数据变更会在 2 秒后自动同步到 GitHub Gist，实现跨设备数据同步`})]}),(0,h.jsx)(o.Item,{name:`githubToken`,label:`GitHub Token`,rules:b?[{required:!0,message:`请输入 GitHub Token`}]:[],extra:(0,h.jsx)(`a`,{href:`https://github.com/settings/tokens/new`,target:`_blank`,rel:`noopener noreferrer`,style:{fontSize:12},children:`如何获取 Token？`}),children:(0,h.jsx)(i.Password,{placeholder:`ghp_xxxxxxxxxxxx`,disabled:!b})}),(0,h.jsx)(o.Item,{name:`githubGistId`,label:(0,h.jsxs)(a,{children:[(0,h.jsx)(`span`,{children:`Gist ID`}),b&&w?.trim()&&(0,h.jsx)(r,{type:`link`,size:`small`,onClick:async()=>{let e=_.getFieldValue(`githubToken`)?.trim();if(!e){c.error(`请先填写 GitHub Token`);return}C(!0);try{let t=`web-tab-${Date.now()}`,n=await fetch(`https://api.github.com/gists`,{method:`POST`,headers:{Authorization:`token ${e}`,Accept:`application/vnd.github.v3+json`,"Content-Type":`application/json`},body:JSON.stringify({description:t,public:!1,files:{"placeholder.json":{content:JSON.stringify({placeholder:!0},null,2)}}})});if(!n.ok){let e=await n.json().catch(()=>({}));throw Error(e.message||`Failed to create gist: ${n.statusText}`)}let r=await n.json();_.setFieldValue(`githubGistId`,r.id),c.success(`Gist 创建成功`)}catch(e){console.error(`[Settings] Create gist error:`,e),c.error(`创建失败: `+e.message)}finally{C(!1)}},loading:S,style:{padding:0,height:`auto`},children:`创建`})]}),rules:b?[{required:!0,message:`请输入 Gist ID 或点击创建按钮创建`}]:[],children:(0,h.jsx)(i,{placeholder:`请输入 Gist ID 或点击创建按钮创建`,disabled:!b})})]}),(0,h.jsx)(l,{}),(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`h3`,{style:{marginBottom:16,fontSize:16,fontWeight:500},children:`背景设置`}),(0,h.jsx)(o.Item,{name:`backgroundType`,label:`背景类型`,children:(0,h.jsxs)(d,{children:[(0,h.jsx)(g,{value:`image`,children:`图片`}),(0,h.jsx)(g,{value:`video`,children:`视频`})]})}),(0,h.jsx)(o.Item,{noStyle:!0,shouldUpdate:(e,t)=>e.backgroundType!==t.backgroundType,children:({getFieldValue:e})=>{let t=e(`backgroundType`);return(0,h.jsxs)(h.Fragment,{children:[t===`image`&&(0,h.jsx)(o.Item,{name:`backgroundImage`,label:`图片 URL`,children:(0,h.jsx)(i,{placeholder:`https://example.com/image.jpg`})}),t===`video`&&(0,h.jsx)(o.Item,{name:`backgroundVideo`,label:`视频 URL`,children:(0,h.jsx)(i,{placeholder:`https://example.com/video.mp4`})})]})}})]}),(0,h.jsx)(o.Item,{style:{marginTop:24,marginBottom:0},children:(0,h.jsx)(r,{type:`primary`,htmlType:`submit`,block:!0,loading:v,children:`保存设置`})})]})})})}export{_ as default};